<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnityÊÄßËÉΩÂàÜÊûêÁÅ´ÁÑ∞ÂõæÂ∑•ÂÖ∑</title>
    <style>
        /* Êï¥ÂêàÁöÑÂÆåÊï¥CSSÊ†∑Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976D2;
        }

        .btn-generate {
            background-color: #4CAF50;
            color: white;
            width: 100%;
            margin-top: 20px;
        }

        .btn-generate:hover {
            background-color: #45a049;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background-color: #e8f5e8;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #2e7d32;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
        }

        .file-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .file-label {
            display: block;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-label:hover {
            background-color: #45a049;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .import-info {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }

        .stats {
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-item .label {
            font-size: 12px;
            color: #555;
            flex: 1;
        }

        .stat-item input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .checkboxes {
            margin-bottom: 15px;
        }

        .checkboxes label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .checkboxes input[type="checkbox"] {
            margin-right: 8px;
        }

        .dropdown {
            margin-bottom: 15px;
        }

        .dropdown label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #555;
        }

        .dropdown select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
        }

        .stats-display {
            background-color: #f0f8f0;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .stat-row:last-child {
            margin-bottom: 0;
        }

        .stat-row .label {
            color: #555;
        }

        .function-details {
            background-color: #f0f8f0;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }

        .detail-item {
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-stats {
            font-size: 12px;
            color: #555;
        }

        .detail-stats div {
            margin-bottom: 4px;
        }

        .time-value {
            color: #ff6b35;
            font-weight: bold;
        }

        .percentage {
            color: #4CAF50;
            font-weight: bold;
        }

        .call-count, .child-count {
            color: #2196F3;
            font-weight: bold;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .breadcrumb {
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
            background-color: #f9f9f9;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .breadcrumb span {
            color: #2196F3;
            cursor: pointer;
        }

        .breadcrumb span:hover {
            text-decoration: underline;
        }

        .flame-graph-container {
            flex: 1;
            position: relative;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        #flameGraph {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 300px;
            word-wrap: break-word;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid #ddd;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
            
            .main-content {
                min-height: 400px;
            }
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        /* Âä®ÁîªÊïàÊûú */
        .section {
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-1px);
        }

        .btn {
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* ÂéüÊúâÊ†∑ÂºèÁªßÁª≠‰øùÊåÅ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d5a27, #4a7c59);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .main-layout {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar {
            width: 300px;
            background: #2a2a2a;
            border-right: 1px solid #444;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            border-bottom: 1px solid #444;
            padding: 15px;
        }

        .sidebar-section h3 {
            color: #4a7c59;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .data-import {
            background: #333;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 10px;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .json-paste {
            margin-top: 10px;
        }

        .json-textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .btn {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #5a8c69;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .display-settings {
            background: #2a2a2a;
        }

        /* ÈúÄË¶ÅÊ∞¥Âπ≥Â∏ÉÂ±ÄÁöÑ‰∏§È°πÂÆπÂô® */
        .horizontal-items {
            display: flex; /* ÂêØÁî®flexÂ∏ÉÂ±Ä */
            gap: 10px;    /* È°π‰πãÈó¥ÁöÑÈó¥Ë∑ù */
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
        }

        .slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .slider-value {
            font-size: 12px;
            color: #999;
        }

        .checkbox-group {
            display: flex;
            flex-direction: row;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .color-scheme-select {
            width: 100%;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .color-scheme-select option {
            background: #444;
            color: #e0e0e0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4a7c59;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .function-details {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid #444;
        }

        .function-details .detail-header {
            color: #4a7c59;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }

        .function-details .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .function-details .detail-label {
            color: #ccc;
            font-weight: 500;
        }

        .function-details .detail-value {
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }

        .function-details .detail-value.highlight {
            color: #4a7c59;
            font-weight: bold;
        }

        .function-details .detail-value.warning {
            color: #f39c12;
        }

        .function-details .detail-value.danger {
            color: #e74c3c;
        }

        .function-details .performance-bar {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .function-details .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a7c59, #f39c12, #e74c3c);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .breadcrumb {
            background: #2a2a2a;
            padding: 10px 15px;
            border-bottom: 1px solid #444;
            font-size: 14px;
            white-space: nowrap;
            overflow-x: auto;
        }

        .breadcrumb-item {
            color: #4a7c59;
            cursor: pointer;
            text-decoration: none;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #666;
        }

        .toolbar {
            background: #2a2a2a;
            padding: 10px 15px;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            background: #444;
            border: 1px solid #666;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
        }

        .flame-graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #1a1a1a;
        }

        .flame-graph {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        .flame-box {
            position: absolute;
            border: 1px solid rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 11px;
            color: #000;
            font-weight: 500;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            padding: 2px 4px;
            box-sizing: border-box;
            transition: all 0.15s ease;
            border-radius: 2px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }

        .flame-box:hover {
            border-color: rgba(0,0,0,0.6);
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .flame-box.selected {
            border: 2px solid #2c5aa0;
            z-index: 101;
            box-shadow: 0 0 0 1px rgba(44, 90, 160, 0.3);
        }

        .flame-box.highlighted {
            border: 2px solid #e74c3c;
            z-index: 102;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.3);
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.3), 0 0 10px rgba(231, 76, 60, 0.2); 
            }
            50% { 
                box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.5), 0 0 20px rgba(231, 76, 60, 0.4); 
            }
        }

        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 35px;
            height: 35px;
            background: rgba(42, 42, 42, 0.9);
            border: 1px solid #666;
            border-radius: 4px;
            color: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background: rgba(74, 124, 89, 0.9);
        }

        .status-bar {
            background: #2a2a2a;
            padding: 8px 15px;
            border-top: 1px solid #444;
            font-size: 12px;
            color: #999;
        }

        .tooltip {
            position: absolute;
            background: rgba(42, 42, 42, 0.95);
            border: 1px solid #666;
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            color: #e0e0e0;
            pointer-events: none;
            z-index: 1001;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #4a7c59;
        }

        .tooltip-info {
            line-height: 1.4;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 16px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>UnityÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑</h1>
            <div class="subtitle">ÂáΩÊï∞Ë∞ÉÁî®Êó∂Â∫èÁÅ´ÁÑ∞Âõæ</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="sidebar-section data-import">
                <h3>Êï∞ÊçÆÂØºÂÖ•</h3>
                <div class="file-input-container">
                    <input type="file" id="fileInput" accept=".json" style="display: none;" />
                    <label for="fileInput" class="file-input-button">ÈÄâÊã©JSONÊñá‰ª∂</label>
                </div>
                <div class="json-paste">
                    <textarea id="jsonTextarea" class="json-textarea" placeholder="ÊàñÁ≤òË¥¥JSONÊï∞ÊçÆ..."></textarea>
                </div>
                <button id="parseJsonBtn" class="btn">Ê∑ªÂä†JSONÊï∞ÊçÆ</button>
                <div class="horizontal-items">
                    <button id="loadSampleBtn" class="btn">Ê∑ªÂä†Á§∫‰æãÊï∞ÊçÆ</button>
                </div>

                <!-- Êï∞ÊçÆÊñá‰ª∂ÂàóË°® -->
                <div class="data-list-section" style="margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #4a7c59;">üìÅ Êï∞ÊçÆÊñá‰ª∂ÂàóË°®</h4>
                    <div class="data-selector">
                        <label style="font-size: 12px; color: #ccc; margin-bottom: 5px; display: block;">Êï∞ÊçÆÂàóË°® First:</label>
                        <select id="dataFirstSelect" class="data-select" style="width: 100%; margin-bottom: 10px; padding: 5px; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 3px;">
                            <option value="">ËØ∑ÈÄâÊã©Êï∞ÊçÆ...</option>
                        </select>
                        
                        <label style="font-size: 12px; color: #ccc; margin-bottom: 5px; display: block;">Êï∞ÊçÆÂàóË°® Second (ÂèØÈÄâ):</label>
                        <select id="dataSecondSelect" class="data-select" style="width: 100%; margin-bottom: 10px; padding: 5px; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 3px;">
                            <option value="">Êó†ÂØπÊØîÊï∞ÊçÆ</option>
                        </select>
                    </div>
                    
                    <!-- Êï∞ÊçÆÊñá‰ª∂ÂàóË°®ÊòæÁ§∫ -->
                    <div id="dataFileList" class="data-file-list" style="max-height: 120px; overflow-y: auto; border: 1px solid #444; border-radius: 3px; background: #1a1a1a;">
                        <div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">ÊöÇÊó†Êï∞ÊçÆÊñá‰ª∂</div>
                    </div>
                    
                    <!-- DiffÂõæ‰æã -->
                    <div id="diffLegend" class="diff-legend" style="margin-top: 10px; font-size: 11px; display: none;">
                        <div class="horizontal-items">
                            <div style="color: #e74c3c; margin-bottom: 2px;">üî¥ ÊÄßËÉΩ‰∏ãÈôç</div>
                            <div style="color: #27ae60; margin-bottom: 2px;">üü¢ ÊÄßËÉΩÊèêÂçá</div>
                            <div style="color: #f39c12; margin-bottom: 2px;">üü† Êñ∞Â¢ûÂáΩÊï∞</div>
                            <div style="color: #8e44ad; margin-bottom: 2px;">üü£ Âà†Èô§ÂáΩÊï∞</div>
                            <div style="color: #95a5a6;">‚ö™ Êó†ÊòéÊòæÂèòÂåñ</div>
                        </div>
                    </div>
                </div>
            </div>            

            <div class="sidebar-section">
                <h3>ÊÄßËÉΩÂàÜÊûê</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalTime">0</div>
                        <div class="stat-label">ÊÄªÊâßË°åÊó∂Èó¥(ms)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="hottestFunction">-</div>
                        <div class="stat-label">ÊÄßËÉΩÁÉ≠ÁÇπ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="slowFunctions">0</div>
                        <div class="stat-label">ÊÖ¢ÂáΩÊï∞(>10ms)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="performanceScore">0</div>
                        <div class="stat-label">ÊÄßËÉΩËØÑÂàÜ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="maxDepth">0</div>
                        <div class="stat-label">Ë∞ÉÁî®Ê∑±Â∫¶</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="systemCallRatio">0%</div>
                        <div class="stat-label">Á≥ªÁªüË∞ÉÁî®Âç†ÊØî</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>ÂáΩÊï∞ËØ¶ÊÉÖ</h3>
                <div id="functionDetails" class="function-details">
                    ÁÇπÂáªÁÅ´ÁÑ∞Âõæ‰∏≠ÁöÑÂáΩÊï∞ÂùóÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ
                </div>
            </div>

            
            <div class="sidebar-section display-settings">
                <h3>ÊòæÁ§∫ËÆæÁΩÆ</h3>
                <div class="setting-item">
                    <label>Êó∂Èó¥ÈòàÂÄº (ms)</label>
                    <input type="range" id="thresholdSlider" class="slider" min="0" max="10" step="0.1" value="0.1">
                    <div class="slider-value" id="thresholdValue">0.1</div>
                </div>
                <div class="setting-item">
                    <label>Ë°åÈ´ò (px)</label>
                    <input type="range" id="rowHeightSlider" class="slider" min="15" max="40" step="1" value="24">
                    <div class="slider-value" id="rowHeightValue">24</div>
                </div>
                <div class="setting-item">
                    <label>ÊúÄÂ∞èÂÆΩÂ∫¶ (px)</label>
                    <input type="range" id="minWidthSlider" class="slider" min="1" max="20" step="1" value="3">
                    <div class="slider-value" id="minWidthValue">3</div>
                </div>                
            </div>
        </div>

        <div class="content-area">
            <div id="breadcrumb" class="breadcrumb">
                <a href="#" class="breadcrumb-item" data-node-id="root">Ê†πËäÇÁÇπ</a>
            </div>

            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="ÊêúÁ¥¢ÂáΩÊï∞Âêç...">
                    <button id="searchClear" class="search-clear">√ó</button>
                </div>
                <button id="resetViewBtn" class="btn">ÈáçÁΩÆËßÜÂõæ</button>
                <button id="fitViewBtn" class="btn">ÈÄÇÂ∫îËßÜÂõæ</button>
                <button id="exportBtn" class="btn">ÂØºÂá∫ÂõæÁâá</button>

                <div class="setting-item">
                    <label>ÈÖçËâ≤ÊñπÊ°à</label>
                    <select id="colorSchemeSelect" class="color-scheme-select">
                        <option value="performance">ÊÄßËÉΩÂØºÂêë</option>
                        <option value="rainbow">ÂΩ©ËôπËâ≤Ë∞±</option>
                        <option value="warm">ÊöñËâ≤Ë∞É</option>
                        <option value="cool">ÂÜ∑Ëâ≤Ë∞É</option>
                        <option value="monochrome">ÂçïËâ≤Ë∞É</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>ÊòæÁ§∫ÈÄâÈ°π</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showSystemCalls" checked>
                            <label for="showSystemCalls">ÊòæÁ§∫Á≥ªÁªüË∞ÉÁî®</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showUserCode" checked>
                            <label for="showUserCode">ÊòæÁ§∫Áî®Êà∑‰ª£Á†Å</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showTooltips" checked>
                            <label for="showTooltips">ÊòæÁ§∫Â∑•ÂÖ∑ÊèêÁ§∫</label>
                        </div>
                    </div>
                </div>

            </div>

            <div id="flameGraphContainer" class="flame-graph-container">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div>ËØ∑ÂØºÂÖ•JSONÊï∞ÊçÆÊñá‰ª∂ÊàñÂä†ËΩΩÁ§∫‰æãÊï∞ÊçÆÂºÄÂßãÂàÜÊûê</div>
                </div>
                <div id="flameGraph" class="flame-graph"></div>            
            </div>

            <div class="status-bar">
                <span id="statusText">Â∞±Áª™</span>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip" style="display: none;">
        <div class="tooltip-title"></div>
        <div class="tooltip-info"></div>
    </div>

    <script>
        // FlameGraphÁ±ª - Êï¥ÂêàËá™flame-graph.js
        class FlameGraph {
            constructor(container, options = {}) {
                this.container = container;
                this.canvas = null;
                this.ctx = null;
                this.data = null;
                this.nodeMap = new Map();
                this.maxDepth = 0;
                this.selectedNode = null;
                this.focusedNode = null;
                this.highlightedFunction = null;
                this.zoomLevel = 1;
                this.panOffset = { x: 0, y: 0 };
                this.isDragging = false;
                this.mouseDownPos = { x: 0, y: 0 };
                this.mouseDownTime = 0;
                this.lastMousePos = { x: 0, y: 0 };
                this.lastClickTime = 0;
                this.diffData = null;
                this.isDiffMode = false;
                this.diffNodeMap = new Map();
                
                // ÈÖçÁΩÆÈÄâÈ°π
                this.config = {
                    rowHeight: options.rowHeight || 20,
                    minWidth: options.minWidth || 1,
                    threshold: options.threshold || 0.1,
                    colorScheme: options.colorScheme || 'default',
                    showLabels: options.showLabels !== false,
                    showTooltip: options.showTooltip !== false,
                    ...options
                };
                
                // È¢úËâ≤ÊñπÊ°à
                this.colorSchemes = {
                    default: {
                        normal: ['#ff6b35', '#f7931e', '#ffd23f', '#06ffa5', '#1fb3d3', '#5d4e75'],
                        hot: '#ff4444',
                        cold: '#4444ff',
                        neutral: '#888888'
                    },
                    warm: {
                        normal: ['#ff9999', '#ffcc99', '#ffff99', '#ccff99', '#99ffcc', '#99ccff'],
                        hot: '#ff6666',
                        cold: '#6666ff',
                        neutral: '#999999'
                    },
                    cool: {
                        normal: ['#99ccff', '#99ffcc', '#ccff99', '#ffff99', '#ffcc99', '#ff9999'],
                        hot: '#6666ff',
                        cold: '#ff6666',
                        neutral: '#999999'
                    }
                };
                
                this.init();
            }
            
            init() {
                this.createCanvas();
                this.bindEvents();
            }
            
            createCanvas() {
                this.canvas = document.createElement('canvas');
                this.canvas.style.width = '100%';
                this.canvas.style.height = '100%';
                this.canvas.style.cursor = 'crosshair';
                this.container.appendChild(this.canvas);
                this.ctx = this.canvas.getContext('2d');
                this.resize();
            }
            
            bindEvents() {
                // Èº†Ê†á‰∫ã‰ª∂
                this.canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.canvas.addEventListener('wheel', this.onWheel.bind(this));
                this.canvas.addEventListener('dblclick', this.onDoubleClick.bind(this));
                
                // Á™óÂè£Â§ßÂ∞èÂèòÂåñ
                window.addEventListener('resize', this.resize.bind(this));
            }
            
            resize() {
                const rect = this.container.getBoundingClientRect();
                this.canvas.width = rect.width * window.devicePixelRatio;
                this.canvas.height = rect.height * window.devicePixelRatio;
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                this.render();
            }
            
            setData(data) {
                this.data = data;
                this.processData();
                this.render();
            }
            
            processData() {
                if (!this.data) return;
                
                this.nodeMap.clear();
                this.maxDepth = 0;
                this.processNode(this.data, 0, 0, this.data.duration || this.data.value || 0);
            }
            
            processNode(node, depth, startTime, totalTime) {
                const duration = node.duration || node.value || 0;
                const selfTime = node.selfTime || duration;
                
                node.id = node.id || `node_${Math.random().toString(36).substr(2, 9)}`;
                node.depth = depth;
                node.startTime = startTime;
                node.duration = duration;
                node.selfTime = selfTime;
                node.percentage = totalTime > 0 ? (duration / totalTime) * 100 : 0;
                
                this.nodeMap.set(node.id, node);
                this.maxDepth = Math.max(this.maxDepth, depth);
                
                if (node.children && node.children.length > 0) {
                    // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Â≠êËäÇÁÇπÔºåÂ±Ö‰∏≠ÊîæÁΩÆ
                    if (node.children.length === 1) {
                        const child = node.children[0];
                        const childDuration = child.duration || child.value || 0;
                        const centerStart = startTime + (duration - childDuration) / 2;
                        this.processNode(child, depth + 1, centerStart, totalTime);
                    } else {
                        // Â§ö‰∏™Â≠êËäÇÁÇπÊåâÈ°∫Â∫èÊéíÂàó
                        let childStartTime = startTime;
                        node.children.forEach(child => {
                            const childDuration = child.duration || child.value || 0;
                            this.processNode(child, depth + 1, childStartTime, totalTime);
                            childStartTime += childDuration;
                        });
                    }
                }
            }
            
            render() {
                if (!this.canvas || !this.data) return;
                
                const rect = this.container.getBoundingClientRect();
                this.ctx.clearRect(0, 0, rect.width, rect.height);
                
                this.renderNode(this.data, 0, 0, rect.width, this.data.duration || this.data.value || 0);
            }
            
            renderNode(node, x, y, width, totalTime) {
                const duration = node.duration || node.value || 0;
                const nodeWidth = (duration / totalTime) * width;
                const nodeHeight = this.config.rowHeight;
                
                if (nodeWidth < this.config.minWidth) return;
                
                // ËÆ°ÁÆóÈ¢úËâ≤
                const color = this.getNodeColor(node);
                
                // ÁªòÂà∂ËäÇÁÇπ
                this.ctx.fillStyle = color;
                this.ctx.fillRect(x, y, nodeWidth, nodeHeight);
                
                // ÁªòÂà∂ËæπÊ°Ü
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 0.5;
                this.ctx.strokeRect(x, y, nodeWidth, nodeHeight);
                
                // ÁªòÂà∂ÊñáÊú¨
                if (this.config.showLabels && nodeWidth > 50) {
                    this.ctx.fillStyle = '#000';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'left';
                    this.ctx.textBaseline = 'middle';
                    
                    const text = this.truncateText(node.name || 'Unknown', nodeWidth - 4);
                    this.ctx.fillText(text, x + 2, y + nodeHeight / 2);
                }
                
                // ÈÄíÂΩíÁªòÂà∂Â≠êËäÇÁÇπ
                if (node.children && node.children.length > 0) {
                    let childX = x;
                    node.children.forEach(child => {
                        const childDuration = child.duration || child.value || 0;
                        const childWidth = (childDuration / totalTime) * width;
                        this.renderNode(child, childX, y + nodeHeight, childWidth, totalTime);
                        childX += childWidth;
                    });
                }
            }
            
            getNodeColor(node) {
                const colors = this.colorSchemes[this.config.colorScheme].normal;
                const hash = this.hashString(node.name || 'Unknown');
                return colors[hash % colors.length];
            }
            
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash);
            }
            
            truncateText(text, maxWidth) {
                const metrics = this.ctx.measureText(text);
                if (metrics.width <= maxWidth) return text;
                
                let truncated = text;
                while (this.ctx.measureText(truncated + '...').width > maxWidth && truncated.length > 0) {
                    truncated = truncated.slice(0, -1);
                }
                return truncated + '...';
            }
            
            onMouseDown(event) {
                this.isDragging = true;
                this.mouseDownPos = { x: event.clientX, y: event.clientY };
                this.mouseDownTime = Date.now();
                this.canvas.style.cursor = 'grabbing';
            }
            
            onMouseMove(event) {
                if (this.isDragging) {
                    const deltaX = event.clientX - this.lastMousePos.x;
                    const deltaY = event.clientY - this.lastMousePos.y;
                    this.panOffset.x += deltaX;
                    this.panOffset.y += deltaY;
                    this.render();
                }
                
                this.lastMousePos = { x: event.clientX, y: event.clientY };
                
                // ÊòæÁ§∫Â∑•ÂÖ∑ÊèêÁ§∫
                if (this.config.showTooltip) {
                    this.showTooltip(event);
                }
            }
            
            onMouseUp(event) {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.canvas.style.cursor = 'crosshair';
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÁÇπÂáªËÄå‰∏çÊòØÊãñÊãΩ
                    const timeDiff = Date.now() - this.mouseDownTime;
                    const distance = Math.sqrt(
                        Math.pow(event.clientX - this.mouseDownPos.x, 2) +
                        Math.pow(event.clientY - this.mouseDownPos.y, 2)
                    );
                    
                    if (timeDiff < 300 && distance < 5) {
                        this.onClick(event);
                    }
                }
            }
            
            // onWheel(event) {
            //     event.preventDefault();
            //     const delta = event.deltaY > 0 ? 0.9 : 1.1;
            //     this.zoomLevel *= delta;
            //     this.zoomLevel = Math.max(0.1, Math.min(10, this.zoomLevel));
            //     this.render();
            // }
            
            onDoubleClick(event) {
                // ÈáçÁΩÆËßÜÂõæ
                this.zoomLevel = 1;
                this.panOffset = { x: 0, y: 0 };
                this.render();
            }
            
            onClick(event) {
                const rect = this.canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                const clickedNode = this.getNodeAtPosition(x, y);
                if (clickedNode) {
                    this.selectNode(clickedNode);
                }
            }
            
            getNodeAtPosition(x, y) {
                // ÁÆÄÂåñÂÆûÁé∞ÔºåÂÆûÈôÖÂ∫îËØ•Ê†πÊçÆÊ∏≤ÊüìÈÄªËæëÊù•Êü•Êâæ
                return null;
            }
            
            selectNode(node) {
                this.selectedNode = node;
                this.render();
                
                // Ëß¶ÂèëÈÄâÊã©‰∫ã‰ª∂
                const event = new CustomEvent('nodeSelected', { detail: node });
                this.container.dispatchEvent(event);
            }
            
            showTooltip(event) {
                // Â∑•ÂÖ∑ÊèêÁ§∫ÂÆûÁé∞
            }
            
            setConfig(config) {
                this.config = { ...this.config, ...config };
                this.render();
            }
            
            exportImage() {
                return this.canvas.toDataURL('image/png');
            }
            
            destroy() {
                if (this.canvas) {
                    this.container.removeChild(this.canvas);
                }
                window.removeEventListener('resize', this.resize.bind(this));
            }
        }
        
        // ÂÖ®Â±ÄÂèòÈáè
        let flameData = null;
        let nodeMap = new Map();
        let maxDepth = 0;
        let selectedNode = null;
        let focusedNode = null;
        let highlightedFunction = null;
        let zoomLevel = 1;
        let panOffset = { x: 0, y: 0 };
        let isDragging = false;
        let mouseDownPos = { x: 0, y: 0 };
        let mouseDownTime = 0;
        let lastMousePos = { x: 0, y: 0 };
        let lastClickTime = 0;
        let diffData = null;
        let isDiffMode = false;
        let diffNodeMap = new Map();
        let dataFileList = []; // Êï∞ÊçÆÊñá‰ª∂ÂàóË°®
        let currentDataIndex = -1; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊï∞ÊçÆÁ¥¢Âºï
        let diffDataIndex = -1; // ÂØπÊØîÊï∞ÊçÆÁ¥¢Âºï

        // DOMÂÖÉÁ¥†ÂºïÁî®
        const fileInput = document.getElementById('fileInput');
        const jsonTextarea = document.getElementById('jsonTextarea');
        const loadSampleBtn = document.getElementById('loadSampleBtn');      
        const parseJsonBtn = document.getElementById('parseJsonBtn');
        const dataFirstSelect = document.getElementById('dataFirstSelect');
        const dataSecondSelect = document.getElementById('dataSecondSelect');
        const dataFileListElement = document.getElementById('dataFileList');
        const diffLegend = document.getElementById('diffLegend');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        const rowHeightSlider = document.getElementById('rowHeightSlider');
        const rowHeightValue = document.getElementById('rowHeightValue');
        const minWidthSlider = document.getElementById('minWidthSlider');
        const minWidthValue = document.getElementById('minWidthValue');
        const colorSchemeSelect = document.getElementById('colorSchemeSelect');
        const showSystemCalls = document.getElementById('showSystemCalls');
        const showUserCode = document.getElementById('showUserCode');
        const showTooltips = document.getElementById('showTooltips');
        const totalTime = document.getElementById('totalTime');
        const hottestFunction = document.getElementById('hottestFunction');
        const slowFunctions = document.getElementById('slowFunctions');
        const performanceScore = document.getElementById('performanceScore');
        const maxDepthElement = document.getElementById('maxDepth');
        const systemCallRatio = document.getElementById('systemCallRatio');
        const functionDetails = document.getElementById('functionDetails');
        const breadcrumb = document.getElementById('breadcrumb');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        const resetViewBtn = document.getElementById('resetViewBtn');
        const fitViewBtn = document.getElementById('fitViewBtn');
        const exportBtn = document.getElementById('exportBtn');
        const flameGraphContainer = document.getElementById('flameGraphContainer');
        const emptyState = document.getElementById('emptyState');
        const flameGraph = document.getElementById('flameGraph');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomResetBtn = document.getElementById('zoomResetBtn');
        const statusText = document.getElementById('statusText');
        const tooltip = document.getElementById('tooltip');

        // Á§∫‰æãÊï∞ÊçÆ
        const sampleData = {
            "name": "Main Thread",
            "startTime": 0,
            "duration": 33.42,
            "type": "thread",
            "children": [
                {
                    "name": "Update",
                    "startTime": 0,
                    "duration": 15.67,
                    "type": "user",
                    "children": [
                        {
                            "name": "PlayerController.Update",
                            "startTime": 0.1,
                            "duration": 8.23,
                            "type": "user",
                            "children": [
                                {
                                    "name": "Input.GetAxis",
                                    "startTime": 0.2,
                                    "duration": 2.15,
                                    "type": "system"
                                },
                                {
                                    "name": "Transform.Translate",
                                    "startTime": 2.5,
                                    "duration": 3.8,
                                    "type": "system"
                                },
                                {
                                    "name": "Rigidbody.AddForce",
                                    "startTime": 6.8,
                                    "duration": 1.28,
                                    "type": "system"
                                }
                            ]
                        },
                        {
                            "name": "CameraController.LateUpdate",
                            "startTime": 8.5,
                            "duration": 4.12,
                            "type": "user",
                            "children": [
                                {
                                    "name": "Camera.ScreenToWorldPoint",
                                    "startTime": 8.7,
                                    "duration": 1.95,
                                    "type": "system"
                                },
                                {
                                    "name": "Transform.LookAt",
                                    "startTime": 10.8,
                                    "duration": 1.77,
                                    "type": "system"
                                }
                            ]
                        },
                        {
                            "name": "UI.Update",
                            "startTime": 13.0,
                            "duration": 2.67,
                            "type": "user",
                            "children": [
                                {
                                    "name": "Canvas.Rebuild",
                                    "startTime": 13.2,
                                    "duration": 2.47,
                                    "type": "system"
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "Render",
                    "startTime": 16.0,
                    "duration": 12.85,
                    "type": "system",
                    "children": [
                        {
                            "name": "Culling",
                            "startTime": 16.2,
                            "duration": 3.45,
                            "type": "system"
                        },
                        {
                            "name": "Shadows",
                            "startTime": 19.8,
                            "duration": 4.23,
                            "type": "system"
                        },
                        {
                            "name": "Opaque",
                            "startTime": 24.2,
                            "duration": 3.67,
                            "type": "system"
                        },
                        {
                            "name": "Transparent",
                            "startTime": 28.0,
                            "duration": 0.85,
                            "type": "system"
                        }
                    ]
                },
                {
                    "name": "Physics.DetectCollisions",
                    "startTime": 29.0,
                    "duration": 4.42,
                    "type": "system",
                    "children": [
                        {
                            "name": "Broadphase",
                            "startTime": 29.2,
                            "duration": 1.23,
                            "type": "system"
                        },
                        {
                            "name": "Narrowphase",
                            "startTime": 30.5,
                            "duration": 2.89,
                            "type": "system"
                        }
                    ]
                }
            ]
        };


        // Ëß£ÊûêJSONÊï∞ÊçÆ
        function parseJsonData() {
            const jsonText = jsonTextarea.value.trim();
            if (!jsonText) {
                setStatus('ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆ');
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                loadFlameData(data);
            } catch (error) {
                setStatus(`JSONËß£ÊûêÈîôËØØ: ${error.message}`);
            }
        }

        // Âä†ËΩΩÁÅ´ÁÑ∞ÂõæÊï∞ÊçÆ
        function loadFlameData(data) {
            flameData = data;
            nodeMap = new Map();
            maxDepth = 0;
            selectedNode = null;
            focusedNode = null;
            highlightedFunction = null;
            
            nodeMap.clear();
            processFlameData(flameData, nodeMap);
            updateStats(flameData);
            renderFlameGraph();
            updateBreadcrumb();
            
            emptyState.style.display = 'none';
            functionDetails.textContent = 'ÁÇπÂáªÁÅ´ÁÑ∞Âõæ‰∏≠ÁöÑÂáΩÊï∞ÂùóÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ';
            setStatus('Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
        }

        // Â§ÑÁêÜÁÅ´ÁÑ∞ÂõæÊï∞ÊçÆ
        function processFlameData(node, _nodeMap, depth = 0, parentId = null) {
            // Ê†áÂáÜÂåñÊï∞ÊçÆÂ≠óÊÆµÔºöÂ∞Ütime/valueÂ≠óÊÆµËΩ¨Êç¢‰∏∫duration
            if (!node.duration) {
                if (node.time !== undefined) {
                    node.duration = node.time;
                } else if (node.value !== undefined) {
                    node.duration = node.value;
                } else {
                    node.duration = 0;
                }
            }
            
            // Â§ÑÁêÜselfTimeÂ≠óÊÆµÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËÆæ‰∏∫0
            if (node.selfTime === undefined) {
                node.selfTime = 0;
            }
            
            // ËÆæÁΩÆÈªòËÆ§startTime - Â±Ö‰∏≠ËÆ°ÁÆó
            if (node.startTime === undefined) {
                if (parentId && _nodeMap.has(parentId)) {
                    const parent = _nodeMap.get(parentId);
                    const parentStart = parent.startTime || 0;
                    const parentDuration = parent.duration || 0;
                    const nodeDuration = node.duration || 0;
                    
                    // Â¶ÇÊûúÂ≠êËäÇÁÇπdurationÂ∞è‰∫éÁà∂ËäÇÁÇπdurationÔºåÂàôÂ±Ö‰∏≠ÊîæÁΩÆ
                    if (nodeDuration < parentDuration) {
                        node.startTime = parentStart + (parentDuration - nodeDuration) / 2;
                    } else {
                        node.startTime = parentStart;
                    }
                } else {
                    node.startTime = 0;
                }
            }
            
            // ÁîüÊàêÂîØ‰∏ÄID
            node.id = `${node.name}_${node.startTime}_${depth}_${Math.random().toString(36).substr(2, 9)}`;
            node.depth = depth;
            node.parentId = parentId;
            
            // Â≠òÂÇ®Âà∞Êò†Â∞Ñ‰∏≠
            _key = `${node.name}_${depth}`;
            _nodeMap.set(_key, node);
            
            // Êõ¥Êñ∞ÊúÄÂ§ßÊ∑±Â∫¶
            maxDepth = Math.max(maxDepth, depth);
            
            // Â§ÑÁêÜÂ≠êËäÇÁÇπ
            if (node.children && node.children.length > 0) {
                if (node.children.length === 1) {
                    // Âçï‰∏™Â≠êËäÇÁÇπÂ∑≤ÁªèÂú®‰∏äÈù¢ÁöÑstartTimeËÆ°ÁÆó‰∏≠Â§ÑÁêÜ‰∫ÜÂ±Ö‰∏≠ÈÄªËæë
                    processFlameData(node.children[0], _nodeMap, depth + 1, node.id);
                } else {
                    // Â§ö‰∏™Â≠êËäÇÁÇπÊåâÈ°∫Â∫èÊéíÂàóÔºåÈáçÊñ∞ËÆ°ÁÆóstartTime
                    let childStartTime = node.startTime || 0;
                    node.children.forEach(child => {
                        // ‰∏∫Â§öÂ≠êËäÇÁÇπÊÉÖÂÜµÈáçÊñ∞ËÆæÁΩÆstartTime
                        child.startTime = childStartTime;
                        processFlameData(child, _nodeMap, depth + 1, node.id);
                        childStartTime += (child.duration || 0);
                    });
                }
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats(data) {
            let functionCount = 0;
            let totalDuration = 0;
            let systemCallCount = 0;
            let slowFunctionCount = 0;
            let hottestNode = null;
            let maxDuration = 0;
            
            function analyzeNodes(node) {
                functionCount++;
                totalDuration += node.duration || 0;
                
                // ÁªüËÆ°Á≥ªÁªüË∞ÉÁî®
                if (node.type === 'system') {
                    systemCallCount++;
                }
                
                // ÁªüËÆ°ÊÖ¢ÂáΩÊï∞
                if (node.duration > 10) {
                    slowFunctionCount++;
                }
                
                // ÊâæÂà∞ÊúÄËÄóÊó∂ÁöÑÂáΩÊï∞
                if (node.duration > maxDuration) {
                    maxDuration = node.duration;
                    hottestNode = node;
                }
                
                if (node.children) {
                    node.children.forEach(analyzeNodes);
                }
            }
            
            analyzeNodes(data);
            
            // ËÆ°ÁÆóÊÄßËÉΩËØÑÂàÜ (0-100)
            const avgDuration = functionCount > 0 ? totalDuration / functionCount : 0;
            const score = Math.max(0, Math.min(100, 100 - (slowFunctionCount * 10) - (avgDuration * 2)));
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            totalTime.textContent = totalDuration.toFixed(2);
            hottestFunction.textContent = hottestNode ? `${hottestNode.name.substring(0, 12)}...` : '-';
            hottestFunction.title = hottestNode ? `${hottestNode.name} (${hottestNode.duration.toFixed(2)}ms)` : '';
            slowFunctions.textContent = slowFunctionCount;
            performanceScore.textContent = Math.round(score);
            maxDepthElement.textContent = maxDepth + 1;
            systemCallRatio.textContent = functionCount > 0 ? `${Math.round((systemCallCount / functionCount) * 100)}%` : '0%';
        }

        // Ê∏≤ÊüìÁÅ´ÁÑ∞Âõæ
        function renderFlameGraph() {
            if (!flameData) return;
            
            flameGraph.innerHTML = '';
            
            const containerWidth = flameGraphContainer.clientWidth;
            const rowHeight = parseInt(rowHeightSlider.value);
            const threshold = parseFloat(thresholdSlider.value);
            const minWidth = parseInt(minWidthSlider.value);
            
            // Á°ÆÂÆöÊ∏≤ÊüìÁöÑÊ†πËäÇÁÇπ
            const rootNode = focusedNode || flameData;
            const baseTime = rootNode.startTime || 0;
            const totalTime = rootNode.duration || 1;
            
            function renderNode(node, depth) {
                // Ê£ÄÊü•ËøáÊª§Êù°‰ª∂
                if (node.duration < threshold) return;
                if (!showSystemCalls.checked && node.type === 'system') return;
                if (!showUserCode.checked && node.type === 'user') return;
                
                // ËÆ°ÁÆó‰ΩçÁΩÆÂíåÂ§ßÂ∞è
                const relativeStart = (node.startTime - baseTime) / totalTime;
                const calculatedWidth = (node.duration / totalTime) * containerWidth * 0.95;
                const width = Math.max(minWidth, calculatedWidth); // Â∫îÁî®ÊúÄÂ∞èÂÆΩÂ∫¶ÈôêÂà∂
                const left = relativeStart * containerWidth * 0.95 + 20;
                const top = (depth - (focusedNode ? focusedNode.depth : 0)) * (rowHeight + 1) + 10;
                
                // Â¶ÇÊûúÂÆΩÂ∫¶Â§™Â∞èÔºåË∑≥ËøáÊ∏≤Êüì‰ª•ÊèêÈ´òÊÄßËÉΩ
                if (calculatedWidth < 0.5) return;
                
                // ÂàõÂª∫ÁÅ´ÁÑ∞Ê°ÜÂÖÉÁ¥†
                const box = document.createElement('div');
                box.className = 'flame-box';
                box.dataset.nodeId = node.id;
                box.style.left = `${left}px`;
                box.style.top = `${top}px`;
                box.style.width = `${width}px`;
                box.style.height = `${rowHeight}px`;
                box.style.backgroundColor = getNodeColor(node);
                
                // Êô∫ËÉΩÊñáÊú¨ÊòæÁ§∫ - ÂèÇËÄÉ d3-flame-graph ÁöÑÊñáÊú¨Â§ÑÁêÜ
                let displayText = '';
                const nodeName = node.name || 'Unknown';
                if (width > 60) {
                    displayText = nodeName;
                } else if (width > 30) {
                    // Êà™Êñ≠ÈïøÂáΩÊï∞Âêç
                    displayText = nodeName.length > 10 ? nodeName.substring(0, 8) + '..' : nodeName;
                } else if (width > 15) {
                    // Âè™ÊòæÁ§∫È¶ñÂ≠óÊØç
                    displayText = nodeName.charAt(0);
                }
                
                box.textContent = displayText;
                const duration = node.duration || 0;
                box.title = `${nodeName} (${duration.toFixed(2)}ms)`;
                
                // Ê∑ªÂä†ÈÄâ‰∏≠ÂíåÈ´ò‰∫ÆÁä∂ÊÄÅ
                if (selectedNode && selectedNode.id === node.id) {
                    box.classList.add('selected');
                }
                if (highlightedFunction && nodeName.toLowerCase().includes(highlightedFunction.toLowerCase())) {
                    box.classList.add('highlighted');
                }
                
                // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                box.addEventListener('mouseenter', (e) => showTooltip(e, node));
                box.addEventListener('mouseleave', hideTooltip);
                
                flameGraph.appendChild(box);
                
                // Ê∏≤ÊüìÂ≠êËäÇÁÇπ
                if (node.children) {
                    node.children.forEach(child => renderNode(child, depth + 1));
                }
            }
            
            renderNode(rootNode, focusedNode ? focusedNode.depth : 0);
        }

        // Ëé∑ÂèñËäÇÁÇπÈ¢úËâ≤ - ÊîØÊåÅÂ§öÁßçÈÖçËâ≤ÊñπÊ°àÂíådiffÊ®°Âºè
        function getNodeColor(node) {
            // DiffÊ®°Âºè‰ºòÂÖà
            if (isDiffMode && node.diffInfo) {
                const diffType = node.diffInfo.diffType;
                switch (diffType) {
                    case 'removed':
                        return '#8e44ad'; // Âà†Èô§ÁöÑÂáΩÊï∞ - Á¥´Ëâ≤
                    case 'added':
                        return '#f39c12'; // Êñ∞Â¢ûÂáΩÊï∞ - Ê©ôËâ≤
                    case 'increased':
                        return '#e74c3c'; // ÊÄßËÉΩ‰∏ãÈôç - Á∫¢Ëâ≤
                    case 'decreased':
                        return '#27ae60'; // ÊÄßËÉΩÊèêÂçá - ÁªøËâ≤
                    default:
                        return '#95a5a6'; // Êó†ÊòéÊòæÂèòÂåñ - ÁÅ∞Ëâ≤
                }
            }
            
            const scheme = colorSchemeSelect.value;
            const hash = hashCode(node.name);
            const hue = Math.abs(hash) % 360;
            
            switch (scheme) {
                case 'performance':
                    // ÊÄßËÉΩÂØºÂêëÈÖçËâ≤
                    if (node.duration > 10) {
                        return `hsl(${(hue + 340) % 360}, 85%, 55%)`; // Á∫¢Ëâ≤Ë∞É
                    } else if (node.duration > 1) {
                        return `hsl(${(hue + 30) % 360}, 80%, 60%)`; // Ê©ôÈªÑËâ≤Ë∞É
                    } else if (node.type === 'system') {
                        return `hsl(${(hue + 270) % 360}, 70%, 70%)`; // Á¥´Ëâ≤Ë∞É
                    } else {
                        return `hsl(${hue}, 70%, 65%)`;
                    }
                    
                case 'rainbow':
                    // ÂΩ©ËôπËâ≤Ë∞±
                    return `hsl(${hue}, 80%, 65%)`;
                    
                case 'warm':
                    // ÊöñËâ≤Ë∞É (Á∫¢„ÄÅÊ©ô„ÄÅÈªÑ)
                    const warmHue = (hue % 60) + (node.depth % 3) * 60; // 0-180Â∫¶
                    return `hsl(${warmHue}, 75%, 65%)`;
                    
                case 'cool':
                    // ÂÜ∑Ëâ≤Ë∞É (Ëìù„ÄÅÁªø„ÄÅÁ¥´)
                    const coolHue = ((hue % 120) + 180) % 360; // 180-300Â∫¶
                    return `hsl(${coolHue}, 75%, 65%)`;
                    
                case 'monochrome':
                    // ÂçïËâ≤Ë∞É (‰∏çÂêå‰∫ÆÂ∫¶ÁöÑËìùËâ≤)
                    const lightness = 40 + (hash % 40); // 40-80%
                    return `hsl(210, 60%, ${lightness}%)`;
                    
                default:
                    return `hsl(${hue}, 70%, 65%)`;
            }
        }
        
        // Â≠óÁ¨¶‰∏≤ÂìàÂ∏åÂáΩÊï∞
        function hashCode(str) {
            if (!str || typeof str !== 'string') {
                return 0;
            }
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // ËΩ¨Êç¢‰∏∫32‰ΩçÊï¥Êï∞
            }
            return hash;
        }

        // ÊòæÁ§∫Â∑•ÂÖ∑ÊèêÁ§∫
        function showTooltip(event, node) {
            if (!showTooltips.checked) return;
            
            const tooltipTitle = tooltip.querySelector('.tooltip-title');
            const tooltipInfo = tooltip.querySelector('.tooltip-info');
            
            tooltipTitle.textContent = node.name;
            tooltipInfo.innerHTML = `
                <div>ÊåÅÁª≠Êó∂Èó¥: ${node.duration.toFixed(2)} ms</div>
                <div>ÂºÄÂßãÊó∂Èó¥: ${node.startTime.toFixed(2)} ms</div>
                <div>Á±ªÂûã: ${node.type}</div>
                <div>Ê∑±Â∫¶: ${node.depth}</div>
                ${node.children ? `<div>Â≠êÂáΩÊï∞: ${node.children.length}</div>` : ''}
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
        }

        // ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
        function hideTooltip() {
            tooltip.style.display = 'none';
        }

        // Êõ¥Êñ∞ÈòàÂÄº
        function updateThreshold() {
            thresholdValue.textContent = thresholdSlider.value;
            renderFlameGraph();
        }

        // Êõ¥Êñ∞Ë°åÈ´ò
        function updateRowHeight() {
            rowHeightValue.textContent = rowHeightSlider.value;
            renderFlameGraph();
        }
        
        // Êõ¥Êñ∞ÊúÄÂ∞èÂÆΩÂ∫¶
        function updateMinWidth() {
            minWidthValue.textContent = minWidthSlider.value;
            renderFlameGraph();
        }

        // ËÆ°ÁÆóÂ∑ÆÂºÇ
        // ÁîüÊàêÂêàÂπ∂ÁöÑdiffÊï∞ÊçÆ
        function generateDiffData(firstData, secondData) {
            if (!firstData || !secondData) return null;
            
            // ÂàõÂª∫ËäÇÁÇπÊò†Â∞Ñ
            const firstNodeMap = new Map();
            const secondNodeMap = new Map();
            
            // ÊûÑÂª∫Á¨¨‰∏Ä‰∏™Êï∞ÊçÆÈõÜÁöÑËäÇÁÇπÊò†Â∞Ñ
            function buildNodeMap(node, map, depth = 0) {
                const nodeKey = `${node.name}_${depth}`;
                map.set(nodeKey, {
                    ...node,
                    depth: depth,
                    duration: node.value || node.duration || 0
                });
                
                if (node.children) {
                    node.children.forEach(child => buildNodeMap(child, map, depth + 1));
                }
            }
            
            buildNodeMap(firstData, firstNodeMap);
            buildNodeMap(secondData, secondNodeMap);
            
            // ÁîüÊàêÂêàÂπ∂ÁöÑdiffÊï∞ÊçÆÁªìÊûÑ
            function createDiffNode(node, depth = 0) {
                const nodeKey = `${node.name}_${depth}`;
                const firstNode = firstNodeMap.get(nodeKey);
                const secondNode = secondNodeMap.get(nodeKey);
                
                const firstDuration = firstNode ? (firstNode.duration || 0) : 0;
                const secondDuration = secondNode ? (secondNode.duration || 0) : 0;
                
                let change = 0;
                let diffType = 'unchanged';
                
                if (!firstNode && secondNode) {
                    // Êñ∞Â¢ûËäÇÁÇπ
                    change = 1;
                    diffType = 'added';
                } else if (firstNode && !secondNode) {
                    // Âà†Èô§ËäÇÁÇπ
                    change = -1;
                    diffType = 'removed';
                } else if (firstNode && secondNode) {
                    // ÂèòÂåñËäÇÁÇπ
                    change = firstDuration > 0 ? (secondDuration - firstDuration) / firstDuration : 0;
                    if (Math.abs(change) > 0.1) {
                        diffType = change > 0 ? 'increased' : 'decreased';
                    }
                }
                
                const diffNode = {
                    name: node.name,
                    duration: secondDuration || firstDuration,
                    startTime: 0, // Á®çÂêéÈáçÊñ∞ËÆ°ÁÆó
                    depth: depth,
                    id: `${node.name}_${depth}_diff`,
                    children: [],
                    diffInfo: {
                        change: change,
                        oldDuration: firstDuration,
                        newDuration: secondDuration,
                        diffType: diffType,
                        exists: !!firstNode,
                        isRemoved: diffType === 'removed'
                    }
                };
                
                // Â§ÑÁêÜÂ≠êËäÇÁÇπ
                const allChildNames = new Set();
                if (firstNode && firstNode.children) {
                    firstNode.children.forEach(child => allChildNames.add(child.name));
                }
                if (secondNode && secondNode.children) {
                    secondNode.children.forEach(child => allChildNames.add(child.name));
                }
                
                allChildNames.forEach(childName => {
                    const firstChild = firstNode && firstNode.children ? 
                        firstNode.children.find(c => c.name === childName) : null;
                    const secondChild = secondNode && secondNode.children ? 
                        secondNode.children.find(c => c.name === childName) : null;
                    
                    const childNode = secondChild || firstChild;
                    if (childNode) {
                        const diffChild = createDiffNode(childNode, depth + 1);
                        diffNode.children.push(diffChild);
                    }
                });
                
                return diffNode;
            }
            
            // ‰ªéÁ¨¨‰∫å‰∏™Êï∞ÊçÆÈõÜÂºÄÂßãÁîüÊàêÔºàÂõ†‰∏∫ÂÆÉÂåÖÂê´‰∫ÜÊúÄÊñ∞ÁöÑÁªìÊûÑÔºâ
            return createDiffNode(secondData);
        }
        
        function calculateDiff() {
            if (!flameData || !diffData) return;
            
            // ÁîüÊàêÂêàÂπ∂ÁöÑdiffÊï∞ÊçÆ
            const mergedDiffData = generateDiffData(flameData, diffData);
            if (!mergedDiffData) return;
            
            // ÈáçÊñ∞ËÆ°ÁÆóstartTime
            function recalculateStartTimes(node, parentStartTime = 0) {
                if (!node) return;
                
                node.startTime = parentStartTime;
                
                if (node.children && node.children.length > 0) {
                    if (node.children.length === 1) {
                        // Âçï‰∏™Â≠êËäÇÁÇπÔºöÂ±Ö‰∏≠ÊòæÁ§∫
                        const child = node.children[0];
                        const centerTime = parentStartTime + (node.duration - child.duration) / 2;
                        recalculateStartTimes(child, centerTime);
                    } else {
                        // Â§ö‰∏™Â≠êËäÇÁÇπÔºöÊåâÈ°∫Â∫èÊéíÂàó
                        let currentTime = parentStartTime;
                        node.children.forEach(child => {
                            recalculateStartTimes(child, currentTime);
                            currentTime += child.duration;
                        });
                    }
                }
            }
            
            recalculateStartTimes(mergedDiffData);
            
            // ÊõøÊç¢ÂΩìÂâçÁöÑflameData‰∏∫ÂêàÂπ∂ÂêéÁöÑdiffÊï∞ÊçÆ
            flameData = mergedDiffData;
        }   

        // Â§ÑÁêÜÊêúÁ¥¢
        function handleSearch() {
            const query = searchInput.value.trim().toLowerCase();
            highlightedFunction = query || null;
            renderFlameGraph();
            
            if (query) {
                setStatus(`ÊêúÁ¥¢: "${query}"`);
            } else {
                setStatus('Â∞±Áª™');
            }
        }

        // Ê∏ÖÈô§ÊêúÁ¥¢
        function clearSearch() {
            searchInput.value = '';
            highlightedFunction = null;
            renderFlameGraph();
            setStatus('Â∑≤Ê∏ÖÈô§ÊêúÁ¥¢');
        }

        // ÈÄâÊã©ËäÇÁÇπ
        function selectNode(node) {
            selectedNode = node;
            updateFunctionDetails(node);
            renderFlameGraph();
        }

        // ÂèñÊ∂àÈÄâÊã©ËäÇÁÇπ
        function deselectNode() {
            selectedNode = null;
            functionDetails.textContent = 'ÁÇπÂáªÁÅ´ÁÑ∞Âõæ‰∏≠ÁöÑÂáΩÊï∞ÂùóÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ';
            renderFlameGraph();
        }

        // Êõ¥Êñ∞ÂáΩÊï∞ËØ¶ÊÉÖ
        function updateFunctionDetails(node) {
            if (!node) {
                functionDetails.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ÁÇπÂáªÁÅ´ÁÑ∞Âõæ‰∏≠ÁöÑÂáΩÊï∞ÂùóÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ</div>';
                return;
            }
            
            // ËÆ°ÁÆóÊÄßËÉΩÁ≠âÁ∫ß
            const getPerformanceLevel = (duration) => {
                if (duration > 10) return { level: 'danger', text: 'ÊÄßËÉΩÁì∂È¢à' };
                if (duration > 1) return { level: 'warning', text: 'ÈúÄË¶ÅÂÖ≥Ê≥®' };
                return { level: 'highlight', text: 'ÊÄßËÉΩËâØÂ•Ω' };
            };
            
            const performance = getPerformanceLevel(node.duration);
            const endTime = node.startTime + node.duration;
            const childCount = node.children ? node.children.length : 0;
            const totalChildTime = node.children ? node.children.reduce((sum, child) => sum + child.duration, 0) : 0;
            const selfTime = node.duration - totalChildTime;
            const selfTimePercent = node.duration > 0 ? (selfTime / node.duration * 100) : 0;
            
            // ËÆ°ÁÆóÊÄßËÉΩÊù°ÁöÑÂÆΩÂ∫¶ (Âü∫‰∫éÁõ∏ÂØπËÄóÊó∂)
            const maxTime = flameData ? flameData.duration : node.duration;
            const performanceWidth = Math.min(100, (node.duration / maxTime) * 100);
            
            functionDetails.innerHTML = `
                <div class="detail-header">
                    üìä ${node.name}
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">ÊâßË°åÊó∂Èó¥:</span>
                    <span class="detail-value ${performance.level}">${node.duration.toFixed(2)} ms</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">ÊÄßËÉΩÁä∂ÊÄÅ:</span>
                    <span class="detail-value ${performance.level}">${performance.text}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Êó∂Èó¥ËåÉÂõ¥:</span>
                    <span class="detail-value">${node.startTime.toFixed(2)} - ${endTime.toFixed(2)} ms</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Ëá™Ë∫´ËÄóÊó∂:</span>
                    <span class="detail-value">${selfTime.toFixed(2)} ms (${selfTimePercent.toFixed(1)}%)</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Ë∞ÉÁî®Ê∑±Â∫¶:</span>
                    <span class="detail-value">Á¨¨ ${node.depth + 1} Â±Ç</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">ÂáΩÊï∞Á±ªÂûã:</span>
                    <span class="detail-value">${node.type === 'system' ? 'üîß Á≥ªÁªüË∞ÉÁî®' : 'üë§ Áî®Êà∑‰ª£Á†Å'}</span>
                </div>
                
                <div class="detail-row">
                     <span class="detail-label">Â≠êÂáΩÊï∞:</span>
                     <span class="detail-value">${childCount} ‰∏™</span>
                 </div>
                 
                 ${node.diffInfo && isDiffMode ? `
                 <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #444;">
                     <div class="detail-header" style="font-size: 13px; margin-bottom: 8px;">üìä DiffÂØπÊØî</div>
                     
                     <div class="detail-row">
                         <span class="detail-label">ÂèòÂåñ:</span>
                         <span class="detail-value ${node.diffInfo.change > 0.1 ? 'danger' : node.diffInfo.change < -0.1 ? 'highlight' : ''}">
                             ${node.diffInfo.change > 0 ? '+' : ''}${(node.diffInfo.change * 100).toFixed(1)}%
                         </span>
                     </div>
                     
                     <div class="detail-row">
                         <span class="detail-label">ÂéüÂßãÊó∂Èó¥:</span>
                         <span class="detail-value">${node.diffInfo.oldDuration.toFixed(2)} ms</span>
                     </div>
                     
                     <div class="detail-row">
                         <span class="detail-label">ÂΩìÂâçÊó∂Èó¥:</span>
                         <span class="detail-value">${node.diffInfo.newDuration.toFixed(2)} ms</span>
                     </div>
                     
                     <div class="detail-row">
                         <span class="detail-label">Áä∂ÊÄÅ:</span>
                         <span class="detail-value">
                             ${node.diffInfo.diffType === 'removed' ? 'üü£ Âà†Èô§ÂáΩÊï∞' :
                               node.diffInfo.diffType === 'added' ? 'üü† Êñ∞Â¢ûÂáΩÊï∞' :
                               node.diffInfo.diffType === 'increased' ? 'üî¥ ÊÄßËÉΩ‰∏ãÈôç' : 
                               node.diffInfo.diffType === 'decreased' ? 'üü¢ ÊÄßËÉΩÊèêÂçá' : '‚ö™ Êó†ÊòéÊòæÂèòÂåñ'}
                         </span>
                     </div>
                 </div>
                 ` : ''}
                 
                 <div style="margin-top: 12px;">
                     <div class="detail-label">Áõ∏ÂØπÊÄßËÉΩ:</div>
                     <div class="performance-bar">
                         <div class="performance-fill" style="width: ${performanceWidth}%"></div>
                     </div>
                 </div>
            `;
        }

        // ËÅöÁÑ¶Âà∞ËäÇÁÇπ
        function focusNode(node) {
            focusedNode = node;
            selectedNode = null;
            renderFlameGraph();
            updateBreadcrumb();
            setStatus(`Â∑≤ËÅöÁÑ¶Âà∞: ${node.name}`);
        }

        // ÈáçÁΩÆËÅöÁÑ¶
        function resetFocus() {
            focusedNode = null;
            selectedNode = null;
            renderFlameGraph();
            updateBreadcrumb();
            setStatus('Â∑≤ÈáçÁΩÆËÅöÁÑ¶');
        }

        // Êõ¥Êñ∞Èù¢ÂåÖÂ±ëÂØºËà™
        function updateBreadcrumb() {
            breadcrumb.innerHTML = '';
            
            // ÊûÑÂª∫Ë∑ØÂæÑ
            const path = [];
            let current = focusedNode;
            
            while (current) {
                path.unshift(current);
                current = current.parentId ? nodeMap.get(current.parentId) : null;
            }
            
            // Ê∑ªÂä†Ê†πËäÇÁÇπ
            if (!focusedNode) {
                path.unshift({ id: 'root', name: 'Ê†πËäÇÁÇπ' });
            } else {
                path.unshift({ id: 'root', name: 'Ê†πËäÇÁÇπ' });
            }
            
            // Ê∏≤ÊüìÈù¢ÂåÖÂ±ë
            path.forEach((node, index) => {
                if (index > 0) {
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '>';
                    breadcrumb.appendChild(separator);
                }
                
                const item = document.createElement('a');
                item.className = 'breadcrumb-item';
                item.href = '#';
                item.textContent = node.name;
                item.dataset.nodeId = node.id;
                breadcrumb.appendChild(item);
            });
        }

        // Â§ÑÁêÜÈù¢ÂåÖÂ±ëÁÇπÂáª
        function handleBreadcrumbClick(event) {
            event.preventDefault();
            
            if (event.target.classList.contains('breadcrumb-item')) {
                const nodeId = event.target.dataset.nodeId;
                
                if (nodeId === 'root') {
                    resetFocus();
                } else {
                    const node = nodeMap.get(nodeId);
                    if (node) {
                        focusNode(node);
                    }
                }
            }
        }

        // ÈáçÁΩÆËßÜÂõæÂèòÊç¢
        function resetViewTransform() {
            zoomLevel = 1;
            panOffset = { x: 0, y: 0 };
            flameGraph.style.transform = 'scale(1) translate(0px, 0px)';
        }

        // Â§ÑÁêÜÈº†Ê†áÊåâ‰∏ã
        function handleMouseDown(event) {
            mouseDownPos = { x: event.clientX, y: event.clientY };
            mouseDownTime = Date.now();
            isDragging = false;
        }

        // Â§ÑÁêÜÈº†Ê†áÁßªÂä®
        function handleMouseMove(event) {
            if (mouseDownTime > 0) {
                const dx = event.clientX - mouseDownPos.x;
                const dy = event.clientY - mouseDownPos.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøáÈòàÂÄºÔºåËÆ§‰∏∫ÊòØÊãñÊãΩ
                if (distance > 5) {
                    isDragging = true;
                    lastMousePos = { x: event.clientX, y: event.clientY };
                    flameGraphContainer.style.cursor = 'grabbing';
                    
                    // Â¶ÇÊûúÊãñÊãΩÂºÄÂßã‰∫éÁÅ´ÁÑ∞Ê°ÜÔºåÂàôÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
                    hideTooltip();
                }
            }
        }

        // Â§ÑÁêÜÈº†Ê†áÊùæÂºÄ
        function handleMouseUp(event) {
            // ËÆ°ÁÆóÈº†Ê†áÊåâ‰∏ãÁöÑÊåÅÁª≠Êó∂Èó¥
            const clickDuration = Date.now() - mouseDownTime;
            
            // Â¶ÇÊûúÊ≤°ÊúâÊãñÊãΩÔºå‰∏îÁÇπÂáªÊó∂Èó¥Áü≠ÔºåÂàôËÆ§‰∏∫ÊòØÁÇπÂáª
            if (!isDragging && clickDuration < 200) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÁÅ´ÁÑ∞Ê°Ü
                if (event.target.classList.contains('flame-box')) {
                    const nodeId = event.target.dataset.nodeId;
                    const node = nodeMap.get(nodeId);
                    
                    if (node) {
                        // Âå∫ÂàÜÂçïÂáªÂíåÂèåÂáª - Áº©Áü≠ÂèåÂáªÊ£ÄÊµãÊó∂Èó¥‰ª•ÊèêÈ´òÂìçÂ∫îÊÄß
                        const now = Date.now();
                        if (now - lastClickTime < 250 && selectedNode && selectedNode.id === node.id) {
                            // ÂèåÂáª - ËÅöÁÑ¶Âà∞ËäÇÁÇπÔºåÊ∑ªÂä†ËßÜËßâÂèçÈ¶à
                            event.target.style.transform = 'scale(1.05)';
                            setTimeout(() => {
                                event.target.style.transform = '';
                            }, 150);
                            focusNode(node);
                            setStatus(`ÂèåÂáªËÅöÁÑ¶: ${node.name}`);
                        } else {
                            // ÂçïÂáª - ÈÄâÊã©ËäÇÁÇπ
                            selectNode(node);
                            setStatus(`Â∑≤ÈÄâÊã©: ${node.name}`);
                        }
                        lastClickTime = now;
                    }
                } else {
                    // ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÂèñÊ∂àÈÄâÊã©
                    if (selectedNode) {
                        deselectNode();
                        setStatus('Â∑≤ÂèñÊ∂àÈÄâÊã©');
                    }
                }
            }
            
            // ÈáçÁΩÆÁä∂ÊÄÅ
            isDragging = false;
            mouseDownTime = 0;
            flameGraphContainer.style.cursor = 'default';
        }

        // Â§ÑÁêÜÈº†Ê†áÁ¶ªÂºÄ
        function handleMouseLeave() {
            isDragging = false;
            mouseDownTime = 0;
            hideTooltip();
            flameGraphContainer.style.cursor = 'default';
        }

        // Èº†Ê†áÊªöËΩÆÁº©Êîæ
        function handleWheel(event) {
            event.preventDefault();
            
            const rect = flameGraphContainer.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;
            
            // Áº©ÊîæÁÇπÁõ∏ÂØπ‰∫éÂΩìÂâçËßÜÂõæÁöÑ‰ΩçÁΩÆ
            const viewX = (mouseX - panOffset.x * zoomLevel) / zoomLevel;
            const viewY = (mouseY - panOffset.y * zoomLevel) / zoomLevel;
            
            // ËÆæÁΩÆÁº©ÊîæÂõ†Â≠ê
            const factor = event.deltaY < 0 ? 1.1 : 0.9;
            zoomLevel *= factor;
            
            // ÈôêÂà∂ÊúÄÂ§ßÂíåÊúÄÂ∞èÁº©ÊîæÁ∫ßÂà´
            zoomLevel = Math.max(0.1, Math.min(5, zoomLevel));
            
            // Ë∞ÉÊï¥Âπ≥ÁßªÂÅèÁßªÈáèÔºå‰ΩøÁº©ÊîæÁÇπ‰øùÊåÅÂú®Áõ∏Âêå‰ΩçÁΩÆ
            panOffset.x = (mouseX / zoomLevel - viewX);
            panOffset.y = (mouseY / zoomLevel - viewY);
            
            flameGraph.style.transform = `scale(${zoomLevel}) translate(${panOffset.x}px, ${panOffset.y}px)`;
        }

        // Áº©ÊîæÁÅ´ÁÑ∞Âõæ
        function zoomFlameGraph(factor) {
            const oldZoom = zoomLevel;
            zoomLevel *= factor;
            zoomLevel = Math.max(0.1, Math.min(5, zoomLevel));
            
            // Ë∞ÉÊï¥Âπ≥ÁßªÂÅèÁßªÈáèÔºå‰ΩøËßÜÂõæ‰∏≠ÂøÉ‰øùÊåÅ‰∏çÂèò
            const rect = flameGraphContainer.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const viewCenterX = (centerX - panOffset.x * oldZoom) / oldZoom;
            const viewCenterY = (centerY - panOffset.y * oldZoom) / oldZoom;
            
            panOffset.x = (centerX / zoomLevel - viewCenterX);
            panOffset.y = (centerY / zoomLevel - viewCenterY);
            
            flameGraph.style.transform = `scale(${zoomLevel}) translate(${panOffset.x}px, ${panOffset.y}px)`;
        }

        // ÈÄÇÂ∫îËßÜÂõæ
        function fitFlameGraphToView() {
            if (!flameData) return;
            
            const rect = flameGraphContainer.getBoundingClientRect();
            const rowHeight = parseInt(rowHeightSlider.value);
            
            // ËÆ°ÁÆóÂΩìÂâçÂèØËßÅÁöÑÊúÄÂ§ßÊ∑±Â∫¶
            function getMaxChildDepth(node) {
                if (!node.children || node.children.length === 0) {
                    return node.depth;
                }
                return Math.max(...node.children.map(getMaxChildDepth));
            }
            
            const visibleDepth = focusedNode ? 
                getMaxChildDepth(focusedNode) + 1 : 
                maxDepth + 1;
            
            const graphHeight = visibleDepth * (rowHeight + 1) + 20;
            const graphWidth = rect.width * 0.95;
            
            // Âè™ËÆ°ÁÆóÊ∞¥Âπ≥ÊñπÂêëÁöÑÁº©ÊîæÂõ†Â≠êÔºå‰øùÊåÅÈ´òÂ∫¶Âíå‰ΩçÁΩÆ‰∏çÂèò
            const scaleX = rect.width / graphWidth;
            
            // Âè™‰ΩøÁî®Ê∞¥Âπ≥Áº©ÊîæÂõ†Â≠êËøõË°åÂÆΩÂ∫¶ÈÄÇÈÖç
            zoomLevel = scaleX * 0.9;
            
            // Âè™Ë∞ÉÊï¥Ê∞¥Âπ≥Â±Ö‰∏≠Ôºå‰øùÊåÅÂûÇÁõ¥‰ΩçÁΩÆ‰∏çÂèò
            panOffset.x = (rect.width / zoomLevel - graphWidth) / 2;
            // panOffset.y ‰øùÊåÅÂΩìÂâçÂÄº‰∏çÂèò
            
            flameGraph.style.transform = `scale(${zoomLevel}) translate(${panOffset.x}px, ${panOffset.y}px)`;
        }

        // ÈáçÁΩÆËßÜÂõæ
        function resetView() {
            // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ
            zoomLevel = 1;
            panOffset = { x: 0, y: 0 };
            searchInput.value = '';
            highlightedFunction = null;
            selectedNode = null;
            focusedNode = null;
            functionDetails.textContent = 'ÁÇπÂáªÁÅ´ÁÑ∞Âõæ‰∏≠ÁöÑÂáΩÊï∞ÂùóÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ';
            
            renderFlameGraph();
            updateBreadcrumb();
            setStatus('Â∑≤ÈáçÁΩÆËßÜÂõæ');
        }

        // ÂØºÂá∫ÂõæÁâá
        function exportImage() {
            setStatus('Ê≠£Âú®ÂáÜÂ§áÂØºÂá∫...');
            
            try {
                // ‰ΩøÁî®html2canvasÂ∫ìÂØºÂá∫ÔºàÂÅáËÆæÂ∑≤Âä†ËΩΩÔºâ
                // Ê≥®ÊÑèÔºöÂÆûÈôÖÂÆûÁé∞ÈúÄË¶ÅÂä†ËΩΩhtml2canvasÂ∫ì
                alert('Ê≠§ÂäüËÉΩÈúÄË¶Åhtml2canvasÂ∫ìÊîØÊåÅÔºåËØ∑Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÈõÜÊàê');
                setStatus('ÂØºÂá∫ÂäüËÉΩÂú®Ê≠§ÊºîÁ§∫‰∏≠‰∏çÂèØÁî®');
                
                // html2canvasÂÆûÁé∞Á§∫‰æãÔºö
                /*
                html2canvas(flameGraph).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'flame-graph.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    setStatus('ÂõæÁâáÂ∑≤ÂØºÂá∫');
                });
                */
            } catch (error) {
                console.error('ÂØºÂá∫ÂõæÁâáÂá∫Èîô:', error);
                setStatus(`ÂØºÂá∫ÈîôËØØ: ${error.message}`);
            }
        }

        // ËÆæÁΩÆÁä∂ÊÄÅÊ∂àÊÅØ
        function setStatus(message) {
            statusText.textContent = message;
        }

        // Ê∑ªÂä†Êï∞ÊçÆÂà∞Êñá‰ª∂ÂàóË°®
        function addDataToList(data, name) {
            const dataItem = {
                id: Date.now() + Math.random(),
                name: name,
                data: JSON.parse(JSON.stringify(data)),
                timestamp: new Date().toLocaleString()
            };
            
            dataFileList.push(dataItem);
            updateDataSelectors();
            updateDataFileListDisplay();
            setStatus(`Â∑≤Ê∑ªÂä†Êï∞ÊçÆ: ${name}`);
        }
        
        // Êõ¥Êñ∞Êï∞ÊçÆÈÄâÊã©Âô®
        function updateDataSelectors() {
            // Ê∏ÖÁ©∫ÈÄâÊã©Âô®
            dataFirstSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Êï∞ÊçÆ...</option>';
            dataSecondSelect.innerHTML = '<option value="">Êó†ÂØπÊØîÊï∞ÊçÆ</option>';
            
            // Ê∑ªÂä†Êï∞ÊçÆÈÄâÈ°π
            dataFileList.forEach((item, index) => {
                const option1 = document.createElement('option');
                option1.value = index;
                option1.textContent = item.name;
                dataFirstSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = index;
                option2.textContent = item.name;
                dataSecondSelect.appendChild(option2);
            });
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Êï∞ÊçÆÔºåËá™Âä®ÈÄâ‰∏≠
            if (dataFileList.length === 1) {
                dataFirstSelect.value = '0';
                handleDataFirstChange();
            }
        }
        
        // Êõ¥Êñ∞Êï∞ÊçÆÊñá‰ª∂ÂàóË°®ÊòæÁ§∫
        function updateDataFileListDisplay() {
            if (dataFileList.length === 0) {
                dataFileListElement.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">ÊöÇÊó†Êï∞ÊçÆÊñá‰ª∂</div>';
                return;
            }
            
            let html = '';
            dataFileList.forEach((item, index) => {
                const isFirst = index == currentDataIndex;
                const isSecond = index == diffDataIndex;
                const statusText = isFirst ? ' [First]' : (isSecond ? ' [Second]' : '');
                const statusColor = isFirst ? '#4a7c59' : (isSecond ? '#7c4a59' : '#666');
                
                html += `
                    <div class="data-file-item" style="padding: 8px; border-bottom: 1px solid #333; font-size: 12px; color: ${statusColor};">
                        <div style="font-weight: bold;">${item.name}${statusText}</div>
                        <div style="color: #888; font-size: 10px;">${item.timestamp}</div>
                        <button onclick="removeDataItem(${index})" style="float: right; margin-top: -20px; background: #444; border: none; color: #ccc; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 10px;">Âà†Èô§</button>
                    </div>
                `;
            });
            
            dataFileListElement.innerHTML = html;
        }
        
        // Âà†Èô§Êï∞ÊçÆÈ°π
        function removeDataItem(index) {
            dataFileList.splice(index, 1);
            
            // Êõ¥Êñ∞Á¥¢Âºï
            if (currentDataIndex === index) {
                currentDataIndex = -1;
                flameData = null;
            } else if (currentDataIndex > index) {
                currentDataIndex--;
            }
            
            if (diffDataIndex === index) {
                diffDataIndex = -1;
                diffData = null;
                isDiffMode = false;
            } else if (diffDataIndex > index) {
                diffDataIndex--;
            }
            
            updateDataSelectors();
            updateDataFileListDisplay();
            
            // ÈáçÊñ∞Ê∏≤Êüì
            if (currentDataIndex >= 0 && dataFileList[currentDataIndex]) {
                loadFlameData(dataFileList[currentDataIndex].data);
            } else {
                clearFlameGraph();
            }
        }
        
        // Â§ÑÁêÜFirstÊï∞ÊçÆÈÄâÊã©ÂèòÂåñ
        function handleDataFirstChange() {
            const selectedIndex = parseInt(dataFirstSelect.value);
            if (selectedIndex >= 0 && dataFileList[selectedIndex]) {
                currentDataIndex = selectedIndex;
                loadFlameData(dataFileList[selectedIndex].data);
                updateDataFileListDisplay();
                setStatus(`Â∑≤ÂàáÊç¢Âà∞: ${dataFileList[selectedIndex].name}`);
            }
        }
        
        // Â§ÑÁêÜSecondÊï∞ÊçÆÈÄâÊã©ÂèòÂåñ
        function handleDataSecondChange() {
            const selectedIndex = parseInt(dataSecondSelect.value);
            
            if (selectedIndex >= 0 && dataFileList[selectedIndex]) {
                diffDataIndex = selectedIndex;
                diffData = dataFileList[selectedIndex].data;
                isDiffMode = true;
                diffLegend.style.display = 'block';
                
                if (flameData) {
                    diffNodeMap.clear();
                    processFlameData(diffData, diffNodeMap);
                    calculateDiff();
                    renderFlameGraph();
                }
                
                updateDataFileListDisplay();
                setStatus(`Â∑≤ÂêØÁî®ÂØπÊØîÊ®°Âºè: ${dataFileList[selectedIndex].name}`);
            } else {
                diffDataIndex = -1;
                diffData = null;
                isDiffMode = false;
                diffLegend.style.display = 'none';
                
                if (flameData) {
                    renderFlameGraph();
                }
                
                updateDataFileListDisplay();
                setStatus('Â∑≤ÂÖ≥Èó≠ÂØπÊØîÊ®°Âºè');
            }
        }
        
        // Ê∏ÖÁ©∫ÁÅ´ÁÑ∞Âõæ
        function clearFlameGraph() {
            flameData = null;
            nodeMap.clear();
            selectedNode = null;
            focusedNode = null;
            svg.innerHTML = '';
            functionDetails.innerHTML = '<div class="no-selection">ÁÇπÂáªËäÇÁÇπÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ</div>';
            breadcrumb.innerHTML = '';
            setStatus('Â∑≤Ê∏ÖÁ©∫ÁÅ´ÁÑ∞Âõæ');
        }
        
        // Âä†ËΩΩÁ§∫‰æãÊï∞ÊçÆ
        function loadSampleData() {
            addDataToList(sampleData, 'Á§∫‰æãÊï∞ÊçÆ');
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const data = JSON.parse(content);
                addDataToList(data, file.name);
            };
            reader.readAsText(file);
        }

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function init() {
            // Êñá‰ª∂ËæìÂÖ•‰∫ã‰ª∂
            fileInput.addEventListener('change', handleFileUpload);
            parseJsonBtn.addEventListener('click', handleJsonPaste);
            loadSampleBtn.addEventListener('click', loadSampleData);

            // Êï∞ÊçÆÈÄâÊã©Âô®‰∫ã‰ª∂
            dataFirstSelect.addEventListener('change', handleDataFirstChange);
            dataSecondSelect.addEventListener('change', handleDataSecondChange);
            
            // ËÆæÁΩÆÊéß‰ª∂‰∫ã‰ª∂
            thresholdSlider.addEventListener('input', updateThreshold);
            rowHeightSlider.addEventListener('input', updateRowHeight);
            minWidthSlider.addEventListener('input', updateMinWidth);
            colorSchemeSelect.addEventListener('change', renderFlameGraph);
            
            showSystemCalls.addEventListener('change', renderFlameGraph);
            showUserCode.addEventListener('change', renderFlameGraph);
            showTooltips.addEventListener('change', () => {
                if (!showTooltips.checked) hideTooltip();
            });
            
            // ÊêúÁ¥¢‰∫ã‰ª∂
            searchInput.addEventListener('input', handleSearch);
            searchClear.addEventListener('click', clearSearch);
            
            // Â∑•ÂÖ∑Ê†èÊåâÈíÆ‰∫ã‰ª∂
            resetViewBtn.addEventListener('click', resetView);
            fitViewBtn.addEventListener('click', fitFlameGraphToView);
            exportBtn.addEventListener('click', exportImage);
            
            // Áº©ÊîæÊéß‰ª∂‰∫ã‰ª∂
            // zoomInBtn.addEventListener('click', () => zoomFlameGraph(1.2));
            // zoomOutBtn.addEventListener('click', () => zoomFlameGraph(0.8));
            // zoomResetBtn.addEventListener('click', () => {
            //     resetViewTransform();
            //     setStatus('Â∑≤ÈáçÁΩÆÁº©Êîæ');
            // });
            
            // ÁÅ´ÁÑ∞ÂõæÂÆπÂô®‰∫ã‰ª∂
            flameGraphContainer.addEventListener('mousedown', handleMouseDown);
            flameGraphContainer.addEventListener('mousemove', handleMouseMove);
            flameGraphContainer.addEventListener('mouseup', handleMouseUp);
            flameGraphContainer.addEventListener('mouseleave', handleMouseLeave);
            flameGraphContainer.addEventListener('wheel', handleWheel);
            
            // Èù¢ÂåÖÂ±ëÂØºËà™‰∫ã‰ª∂
            breadcrumb.addEventListener('click', handleBreadcrumbClick);
            
            // Á™óÂè£Â§ßÂ∞èÂèòÂåñ‰∫ã‰ª∂
            window.addEventListener('resize', () => {
                if (flameData) {
                    renderFlameGraph();
                }
            });
        }
        
        
        // Â§ÑÁêÜJSONÁ≤òË¥¥
        function handleJsonPaste() {
            const jsonText = jsonTextarea.value.trim();
            if (jsonText) {
                try {
                    const data = JSON.parse(jsonText);
                    const timestamp = new Date().toLocaleTimeString();
                    addDataToList(data, `Á≤òË¥¥Êï∞ÊçÆ_${timestamp}`);
                    // Ê∏ÖÁ©∫ÊñáÊú¨Ê°Ü
                    jsonTextarea.value = '';
                } catch (error) {
                    setStatus(`JSONËß£ÊûêÈîôËØØ: ${error.message}`);
                }
            } else {
                setStatus('ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆ');
            }
        }

        // ÂàùÂßãÂåñ
        init();
        
        // Âª∂ËøüÂä†ËΩΩÁ§∫‰æãÊï∞ÊçÆÔºàÊ®°ÊãüÔºâ
        // setTimeout(loadSampleData, 500);
    </script>
</body>
</html>